/*
    @file math/random.h
    @brief Интерфейс для генерации псевдослучайных чисел.
    @author Дмитрий Скляр.
    @version 1.0
    @date 28-01-2026

    @license Лицензия Apache, версия 2.0 («Лицензия»);
          Вы не имеете права использовать этот файл без соблюдения условий Лицензии.
          Копию Лицензии можно получить по адресу http://www.apache.org/licenses/LICENSE-2.0
          Если иное не предусмотрено действующим законодательством или не согласовано в письменной форме,
          программное обеспечение, распространяемое по Лицензии, распространяется на условиях «КАК ЕСТЬ»,
          БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ ИЛИ УСЛОВИЙ, явных или подразумеваемых. См. Лицензию для получения
          информации о конкретных языках, регулирующих разрешения и ограничения по Лицензии.

    @warning Генераторы не подходят для криптографических целей! Используйте специализированные
             криптографические библиотеки для безопасности.

    @note Все функции thread-safe при условии, что каждый поток использует свой генератор. Алгоритмы
          предоставляют одинаковую последовательность на всех платформах при одинаковом seed.
*/
#pragma once

#include <core/defines.h>

// @brief Типы алгоритмов генерации псевдослучайных чисел.
typedef enum math_random_generator_type {
    /*
        @brief Xoshiro256** алгоритм, один из самых быстрых. Рекомендуемый! Скорость ~1 млрд чисел/с, период 2^256-1.
               Не подходит для параллельных вычислений БЕЗ использования jump-функций. Используется для общих случаев.
    */
    MATH_RANDOM_GENERATOR_TYPE_XOSHIRO256,
    /*
        @brief PCG (Permuted Congruential Generator) алгоритм, альтернативная замена rand() алгоритма по качеству.
               Скорость ~0.8 млрд/с, период 2^64. Используется для общих случаев.
    */
    MATH_RANDOM_GENERATOR_TYPE_PCG,
    /*
        @brief Philox (Counter-Based RNG) алгоритм, подходит для многопоточной работы (не зависит от предыдущих генераций).
               Скорость ~0.5 млрд/с, период 2^128. Используется для генерация ландшафтов, научных вычислений и симуляций.
    */
    MATH_RANDOM_GENERATOR_TYPE_PHILOX,
    /*
        @brief SFC64 (Small Fast Chaotic) алгоритм, выдает качественные числа и немного быстрее Xoshiro256**.
               Скорость ~1.2 млрд/с, периода > 2^64. Используется для системы частиц и генерация ландшафтов.
    */
    MATH_RANDOM_GENERATOR_TYPE_SFC64,
    /*
        @brief WyRand алгоритм. Один из самых быстрых высококачественных генераторов. Скорость ~1.5 млрд/с, период 2^64.
    */
    MATH_RANDOM_GENERATOR_TYPE_WYRAND,
    /*
        @brief SplitMix64 алгоритм, выдает качественные числа, но медленнее остальных. Не рекомендуется как основной!
               Скорость ~0.7 млрд/с, период 2^64. Используется для инициализации состояний других генераторов.
    */
    MATH_RANDOM_GENERATOR_TYPE_SPLITMIX64,
    /*
        @brief Количество алгоритмов генерации (не является реальным алгоритмом).
    */
    MATH_RANDOM_GENERATOR_TYPE_COUNT
} math_random_generator_type;

/*
    @brief Генератор псевдослучайных чисел с явным состоянием.
    @note Thread-safe при условии, что каждый поток использует свой генератор.
*/
typedef struct math_random_generator {
    // @brief Тип алгоритма генерации.
    math_random_generator_type type;
    // @brief Текущее состояние генератора.
    union {
        struct {
            // @brief Текущее состояние xoshiro256 (инициализируется через SplitMix64).
            u64 s[4];
        } xoshiro;

        struct {
            // @brief Текущее состояние PCG (инициализируется ненулевым значением) или SplitMix64 или WyRand.
            u64 state;
            // @brief Инкремент PCG (должен быть нечетным). Для SplitMix64 и WyRand не используется.
            u64 inc;
        } pcg, splitmix64, wyrand;

        struct {
            // @brief Счетчик инкрементируется каждый вызов.
            u64 counter[2];
            // @brief Ключ (остается постоянным для генератора).
            u64 key[2];
        } philox;

        struct {
            // @brief Состояние A (инициализируется случайным значением).
            u64 a;
            // @brief Состояние B (инициализируется случайным значением).
            u64 b;
            // @brief Состояние C (инициализируется случайным значением).
            u64 c;
            // @brief Счетчик (должен быть инициализирован нечетным значением).
            u64 w;
        } sfc64;
    } state;
} math_random_generator;

/*
    @brief Инициализирует генератор с указанием типа алгоритма генерации и начальным значением.
    @param gen Указатель на генератор для инициализации.
    @param type Тип алгоритма генерации.
    @param seed Начальное значение. При seed = 0 используется seed на основе системного времени.
*/
API void math_random_generator_init(math_random_generator* gen, math_random_generator_type type, u64 seed);

/*
    @brief Перемещает генератор вперед на 2^128 шагов (jump function).
    @warning Только для MATH_RANDOM_GENERATOR_TYPE_XOSHIRO256, для MATH_RANDOM_GENERATOR_TYPE_PCG функция ничего не делает.
    @note Позволяет создать 2^128 непересекающихся последовательностей из одного seed (полезно для многопоточности).
    @param gen Генератор для модификации.
*/
API void math_random_generator_jump(math_random_generator* gen);

/*
    @brief Перемещает генератор вперед на 2^192 шагов (long jump).
    @warning Только для MATH_RANDOM_GENERATOR_TYPE_XOSHIRO256, для MATH_RANDOM_GENERATOR_TYPE_PCG функция ничего не делает.
    @note Позволяет создать 2^192 непересекающихся последовательностей из одного seed (полезно для многопоточности).
    @param gen Генератор для модификации.
*/
API void math_random_generator_long_jump(math_random_generator* gen);

/*
    @brief Генерирует 32-битное беззнаковое псевдослучайное число.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @return Случайное число в диапазоне [0, U32_MAX].
*/
API u32 math_random_u32(math_random_generator* gen);

/*
    @brief Генерирует 32-битное беззнаковое число в заданном диапазоне.
    @warning При min > max поведение не определено.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param min Минимальное значение (включительно).
    @param max Максимальное значение.
    @return Случайное число в диапазоне [min, max).
*/
API u32 math_random_u32_range(math_random_generator* gen, u32 min, u32 max);

/*
    @brief Генерирует 32-битное знаковое псевдослучайное число.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @return Случайное число в диапазоне [I32_MIN, I32_MAX].
*/
API i32 math_random_i32(math_random_generator* gen);

/*
    @brief Генерирует 32-битное знаковое число в заданном диапазоне.
    @warning При min > max поведение не определено.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param min Минимальное значение (включительно).
    @param max Максимальное значение.
    @return Случайное число в диапазоне [min, max).
*/
API i32 math_random_i32_range(math_random_generator* gen, i32 min, i32 max);

/*
    @brief Генерирует 64-битное беззнаковое псевдослучайное число.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @return Случайное число в диапазоне [0, U64_MAX].
*/
API u64 math_random_u64(math_random_generator* gen);

/*
    @brief Генерирует 64-битное беззнаковое число в заданном диапазоне.
    @warning При min > max поведение не определено.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param min Минимальное значение (включительно).
    @param max Максимальное значение.
    @return Случайное число в диапазоне [min, max).
*/
API u64 math_random_u64_range(math_random_generator* gen, u64 min, u64 max);

/*
    @brief Генерирует 64-битное знаковое псевдослучайное число.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @return Случайное число в диапазоне [I64_MIN, I64_MAX].
*/
API i64 math_random_i64(math_random_generator* gen);

/*
    @brief Генерирует 64-битное знаковое число в заданном диапазоне.
    @warning При min > max поведение не определено.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param min Минимальное значение (включительно).
    @param max Максимальное значение.
    @return Случайное число в диапазоне [min, max).
*/
API i64 math_random_i64_range(math_random_generator* gen, i64 min, i64 max);

/*
    @brief Генерирует число с плавающей точкой одинарной точности.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @return Случайное число в диапазоне [0.0, 1.0).
*/
API f32 math_random_f32(math_random_generator* gen);

/*
    @brief Генерация нескольких чисел за вызов (оптимизация).
    @warning Не стоит использовать слишком большое count, обычно от 4 до 8.
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param count Количество чисел для генерации (должно быть > 0).
    @param out Массив для результатов (размер >= count).
*/
API void math_random_f32_bulk(math_random_generator* gen, u32 count, f32* out);

/*
    @brief Генерирует число с плавающей точкой в заданном диапазоне.
    @warning При min > max поведение не определено. Дискретизация ~ (max - min).
    @note Генератор должен быть инициализирован перед использованием в функции.
    @param gen Инициализированный генератор (не может быть nullptr).
    @param min Минимальное значение (включительно).
    @param max Максимальное значение.
    @return Случайное число в диапазоне [min, max).
*/
API f32 math_random_f32_range(math_random_generator* gen, f32 min, f32 max);
